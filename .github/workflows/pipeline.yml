name: Build

on: [push, pull_request]

jobs:
  Test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]

    steps:
    - uses: actions/checkout@v3
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
    - run: npm ci
    - run: npm test

  Build:
    strategy:
      matrix:
        node-version: [18.x]
        os: 
          - host: ubuntu-latest
            target: node18-linux-x64,node18-macos-x64,node18-win-x64
          - host: macos-latest
            target: node18-macos-arm64

    runs-on: ${{ matrix.os.host }}
    steps:
    - uses: actions/checkout@v3
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
    - run: npm ci
    - run: npm run build --if-present
    - run: make prune package
      env:
        TARGET: ${{ matrix.os.target }}

    - uses: actions/upload-artifact@v3
      with:
        path: bin/*.bz2
        retention-days: 1

  Publish:
    runs-on: ubuntu-latest
    needs: Test
    # if: github.ref == 'refs/heads/master'
    strategy:
      matrix:
        node-version: [18.x]

    steps:
    - uses: actions/checkout@v3
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
    - uses: actions/download-artifact@v3

    - name: Display fetched artifacts
      run: ls -R
    
    - run: npm ci

    - run: make release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
